import logging
import os
import asyncio
import yt_dlp
from aiogram import Bot, Dispatcher, executor, types
from aiogram.utils.exceptions import ChatNotFound

# Loglarni yozib borish
logging.basicConfig(level=logging.INFO)

# Token va kanal username (Railway Variablesâ€™dan olinadi)
BOT_TOKEN = os.getenv("8415194078:AAFETEtK7v-S8zb6LslLj_l6aQtXU6NJSdo")
CHANNEL_USERNAME = os.getenv("@gilosku")  # masalan: @mening_kanalim

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)


# ğŸ”¹ Kanal obunasini tekshirish
async def check_subscription(user_id):
    try:
        member = await bot.get_chat_member(CHANNEL_USERNAME, user_id)
        return member.status in ["member", "administrator", "creator"]
    except ChatNotFound:
        return True  # Agar kanal topilmasa, tekshiruvni o'tkazib yuboramiz


# ğŸ”¹ /start komandasi
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    text = (
        "ğŸ‘‹ Salom! Bu bot orqali Instagram, TikTok va YouTube videolarini yuklab olishingiz mumkin.\n\n"
        "ğŸ¯ Link yuboring va video tayyor boâ€˜ladi!"
    )
    await message.answer(text)


# ğŸ”¹ Foydalanuvchi link yuborsa
@dp.message_handler(content_types=["text"])
async def download_video(message: types.Message):
    user_id = message.from_user.id
    subscribed = await check_subscription(user_id)

    if not subscribed:
        await message.answer(
            f"âŒ Botdan foydalanish uchun avval kanalimizga obuna boâ€˜ling:\n{CHANNEL_USERNAME}"
        )
        return

    url = message.text.strip()
    if not url.startswith("http"):
        await message.answer("â— Iltimos, toâ€˜gâ€˜ri link yuboring.")
        return

    await message.answer("â³ Yuklab olinmoqda, kuting...")

    try:
        # Faylni yuklab olish
        ydl_opts = {
            "outtmpl": "video.%(ext)s",
            "format": "mp4",
        }

        loop = asyncio.get_event_loop()
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = await loop.run_in_executor(None, lambda: ydl.extract_info(url, download=True))
            file_name = ydl.prepare_filename(info)

        # Faylni yuborish
        with open(file_name, "rb") as video:
            await message.answer_video(video)

        # Faylni oâ€˜chirish
        os.remove(file_name)

    except Exception as e:
        await message.answer(f"âŒ Xato yuz berdi: {str(e)}")


# ğŸ”¹ Botni ishga tushirish
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
